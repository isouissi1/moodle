define(["jquery","core/str","core/modal_factory","core/modal_events","core/templates","core/notification","core/ajax"],function(a,b,c,d,e,f,g){var h={BULKACTIONSELECT:"#menuaction",BULKREQUESTCHECKBOXES:"input.request",BULKREQUESTNOSCHECKBOXES:"input.request[value='0']",BULKREQUESTSELECTEDCHECKBOXES:"input.request:checked",BULKACTIONFORM:"#requestactions",CHECKALLBUTTON:"#checkall",CHECKNONEBUTTON:"#checknone"},i=function(a){this.reservationId=a.reservationid,this.attachEventListeners()};return i.prototype.modal=null,i.prototype.reservationId=-1,i.prototype.attachEventListeners=function(){a(h.BULKACTIONSELECT).on("change",function(b){var c=a(b.target).val();if(c.indexOf("#")!==-1){b.preventDefault();var d=[];a(h.BULKREQUESTSELECTEDCHECKBOXES).each(function(b,c){var e=a(c).attr("value");d.push(e)}),"#messageselect"==c&&this.showSendMessage(d).fail(f.exception),a(h.BULKACTIONSELECT).prop("selectedIndex",0)}else""!==c&&(a(h.BULKREQUESTSELECTEDCHECKBOXES).length>0?"deleterequest"==c?this.confirmDeleteRequests(a(h.BULKREQUESTSELECTEDCHECKBOXES).length).fail(f.exception):a(h.BULKACTIONFORM).submit():a(h.BULKACTIONSELECT).prop("selectedIndex",0))}.bind(this)),a(h.CHECKALLBUTTON).on("click",function(){a(h.BULKREQUESTCHECKBOXES).prop("checked",!0)}),a(h.CHECKNONEBUTTON).on("click",function(){a(h.BULKREQUESTCHECKBOXES).prop("checked",!1)})},i.prototype.confirmDeleteRequests=function(e){if(0==e)return a.Deferred().resolve().promise();var f=b.get_string("confirmdelete","mod_reservation");return a.when(c.create({type:c.types.SAVE_CANCEL}),f).then(function(c,e){this.modal=c,this.modal.setBody(e);var f=b.get_string("yes","core_moodle");return this.modal.setSaveButtonText(f),this.modal.getRoot().on(d.hidden,function(){a(h.BULKACTIONSELECT).focus(),this.modal.getRoot().remove()}.bind(this)),this.modal.getRoot().on(d.yes,function(){a(h.BULKACTIONFORM).submit()}),this.modal.show(),this.modal}.bind(this))},i.prototype.showSendMessage=function(f){if(0==f.length)return a.Deferred().resolve().promise();var g=null;return g=1==f.length?b.get_string("sendbulkmessagesingle","core_message"):b.get_string("sendbulkmessage","core_message",f.length),a.when(c.create({type:c.types.SAVE_CANCEL,body:e.render("core_user/send_bulk_message",{})}),g).then(function(b,c){return this.modal=b,this.modal.setTitle(c),this.modal.setSaveButtonText(c),this.modal.getRoot().on(d.hidden,function(){a(h.BULKACTIONSELECT).focus(),this.modal.getRoot().remove()}.bind(this)),this.modal.getRoot().on(d.save,this.submitSendMessage.bind(this,f)),this.modal.show(),this.modal}.bind(this))},i.prototype.submitSendMessage=function(a){var c=this.modal.getRoot().find("form textarea").val(),d=[],e=0;g.call([{methodname:"mod_reservation_get_requests_users",args:{reservationid:this.reservationId,requestids:a}}])[0].then(function(a){for(e=0;e<a.length;e++)d.push({touserid:a[e],text:c});return!0}).then(function(){return g.call([{methodname:"core_message_send_instant_messages",args:{messages:d}}])[0].then(function(a){return 1==a.length?b.get_string("sendbulkmessagesentsingle","core_message"):b.get_string("sendbulkmessagesent","core_message",a.length)}).then(function(a){return f.addNotification({message:a,type:"success"}),!0})["catch"](f.exception)})["catch"](f.exception)},{init:function(a){return new i(a)}}});