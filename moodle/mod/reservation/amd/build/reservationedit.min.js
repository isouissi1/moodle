define(["jquery","core/str","core/modal_factory","core/modal_events","core/templates","core/notification","core/ajax"],function(a,b,c,d,e,f,g){var h={CLASHBUTTON:"#checkclashes",PLACEFIELD:"#id_locationtext",PLACESELECT:"#id_location",TIMESTART:"#id_timestart",TIMEEND:"#id_timeend",BULKFIELD:"select.field",BULKMATCHVALUE:"input.matchvalue"},i=function(a){this.courseId=a.courseid,this.attachEventListeners()};return i.prototype.courseId=-1,i.prototype.modal=null,i.prototype.attachEventListeners=function(){a(h.BULKMATCHVALUE).on("focus",function(b){a(b.target).blur();var c=a(b.target).attr("id");this.showMatchvalues(c).fail(f.exception)}.bind(this)),a(h.CLASHBUTTON).on("click",function(){this.showClashes().fail(f.exception)}.bind(this)),a(h.BULKFIELD).on("change",function(b){var c=a(b.target).attr("id"),d=c.replace("field","matchvalue");a("#"+d).prop("value","")})},i.prototype.showMatchvalues=function(e){var h=e.replace("matchvalue","field"),i=a("#"+h).val();if(""==i)return a.Deferred().resolve().promise();var j=b.get_string("selectvalue","mod_reservation"),k=b.get_string("novalues","mod_reservation");return a.when(c.create({type:c.types.SAVE_CANCEL}),j,k).then(function(b,c,j){return this.modal=b,this.modal.setTitle(c),this.modal.setBody(j),j=g.call([{methodname:"mod_reservation_get_matchvalues",args:{fieldname:i,courseid:this.courseId}}])[0].then(function(b){if(b.length>0){for(var c="<ul>",d=0;d<b.length;d++){var e=a("<div/>").text(b[d]).html();c+='<li class="matchvalues">',c+='<input type="radio" name="matchvalue" value="'+e+'" id="value_'+d+'" />',c+='<label for="value_'+d+'">'+e+"</label>",c+="</li>"}return c+="</ul>",this.modal.setBody(c),!0}}.bind(this))["catch"](f.exception),this.modal.getRoot().on(d.hidden,function(){a("#"+h).focus(),this.modal.getRoot().remove()}.bind(this)),this.modal.getRoot().on(d.save,function(){var b=a("input[name='matchvalue']:checked").val();a("#"+e).prop("value",b)}),this.modal.show(),this.modal}.bind(this))},i.prototype.showClashes=function(){var e=a(h.PLACESELECT).val();0==e&&(e=a(h.PLACEFIELD).val());var i=a(h.TIMESTART+"_day").val(),j=a(h.TIMESTART+"_month").val(),k=a(h.TIMESTART+"_year").val(),l=a(h.TIMESTART+"_hour").val(),m=a(h.TIMESTART+"_minute").val(),n=k+"-"+j+"-"+i+"-"+l+"-"+m,o="";if(a(h.TIMEEND+"_enabled").is(":checked")){var p=a(h.TIMEEND+"_day").val(),q=a(h.TIMEEND+"_month").val(),r=a(h.TIMEEND+"_year").val(),s=a(h.TIMEEND+"_hour").val(),t=a(h.TIMEEND+"_minute").val();o=r+"-"+q+"-"+p+"-"+s+"-"+t}var u=a("input[name='instance']").val(),v=b.get_string("clashesreport","mod_reservation"),w=b.get_string("noclashes","mod_reservation");return a.when(c.create({type:c.types.CANCEL}),v,w).then(function(b,c,i){return this.modal=b,this.modal.setTitle(c),this.modal.setBody(i),i=g.call([{methodname:"mod_reservation_get_clashes",args:{courseid:this.courseId,place:e,timestart:n,timeend:o,reservationid:u}}])[0].then(function(a){if(null!==a)return this.modal.setBody(a),!0}.bind(this))["catch"](f.exception),this.modal.getRoot().on(d.hidden,function(){a(h.CLASHBUTTON).focus(),this.modal.getRoot().remove()}.bind(this)),this.modal.show(),this.modal}.bind(this))},{init:function(a){return new i(a)}}});